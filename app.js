'use strict';
import dotenv from 'dotenv';
import * as functions from './functions.js';
import * as game from './game.js';
import Telegraf from 'telegraf';
import rateLimit from 'telegraf-ratelimit';
dotenv.config();


// Set limit to 75 message per 3 seconds
const limitConfig = {
  window: 3000,
  limit: 75,
  onLimitExceeded: (ctx, next) => ctx.reply('–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–æ')
};



/*const API_TOKEN = process.env.TELEGRAM_TOKEN || '';
const PORT = process.env.PORT || 3000;
const URL_ADDRESS = process.env.URL || 'https://mafiabotjs.com';

export const bot = new Telegraf(API_TOKEN);
bot.telegram.setWebhook(`${URL_ADDRESS}/${process.env.SECRET}`);
//bot.telegram.setWebhook(`${URL}/bot${API_TOKEN}`);
//bot.startWebhook(`/${process.env.SECRET}`, null, PORT);
*/

//–°–æ–∑–¥–∞–µ–º –æ–±—å–µ–∫—Ç –±–æ—Ç–∞
export const bot = new Telegraf(process.env.TELEGRAM_TOKEN);
bot.use(rateLimit(limitConfig));
//bot.use(Telegraf.log()); //–í—ã–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å

//–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.catch((err, ctx) => {
  console.log(`–û–π, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –¥–ª—è ${ctx.updateType}`, err);
  bot.telegram.sendMessage(process.env.CREATOR_ID, `–û–π, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –¥–ª—è ${ctx.updateType} –æ—à–∏–±–∫–∞: ${err}`);
});

//–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ –Ω–∞ –∏–≥—Ä—É, –µ—Å–ª–∏ —Å –∫–æ–º–∞–Ω–¥–æ–π –ø—Ä–∏—à–µ–ª id —á–∞—Ç–∞
bot.start( (ctx) => {
  if (ctx.message.text.length == 6) {
    ctx.reply('–ü—Ä–∏–≤–µ—Ç, –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã –æ—Ç–ø—Ä–∞–≤—å –∫–æ–º–∞–Ω–¥—É /game –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ');
  } else {
    //–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ –Ω–∞ –∏–≥—Ä—É
    functions.registrationUserInGame(ctx, ctx.message.text.slice(7));
  }
});


//–í—ã–≤–æ–¥–∏–º –ø–æ–¥—Å–∫–∞–∑–∫—É
bot.help((ctx) => {
  ctx.reply('–ü—Ä–∏–≤–µ—Ç!\n–Ø –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–≥—Ä–∞—Ç—å –≤ –ú–∞—Ñ–∏—é.\n\n'+
  '–î–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã –º–Ω–µ –Ω—É–∂–Ω–æ –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞ üë®‚Äç‚öñ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:\n\n'+
  '  - –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π\n\n–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π, '+
  '–≤—ã —Å–º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É –∫–æ–º–∞–Ω–¥–æ–π /game\n\n–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–æ–ª–µ–π /role');
});


//–ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
bot.command('game', async (ctx) => {
  //–ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ —Å –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞, —Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  if (functions.checkTypeChat(ctx.message.chat.type)) {
    //–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–ª–∏ –ª–∏ –±–æ—Ç—É –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞
    if (await functions.checkBotAdmin(ctx.message.chat.id)) {
      if (await functions.checkStartGame(ctx.message.chat.id)) {
          await functions.updateOrAddChatInBD(ctx.message.chat.id, ctx.message.chat.title);
          game.launch(ctx.message.chat.id);
      } else {
        ctx.reply('–ò–≥—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞, –Ω–µ –º–µ—à–∞–π—Ç–µ!');
      }
    } else {
      ctx.reply('–°–¥–µ–ª–∞–π—Ç–µ –±–æ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏ –¥–∞–π—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π!');
    }
  } else {
    ctx.reply('–≠—Ç—É –∫–æ–º–∞–Ω–¥—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ!');
  }
});

//–ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
bot.command('role', (ctx) => {
  ctx.reply(`–í –∏–≥—Ä–µ –¥–æ—Å—Ç—É–ø–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Ä–æ–ª–∏:
üë®üèº <b>–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å</b> - –æ–±—ã—á–Ω—ã–π –≥–æ—Ä–æ–∂–∞–Ω–∏–Ω, –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã—á–∏—Å–ª–∏—Ç—å –º–∞—Ñ–∏—é –∏ –ª–∏–Ω—á–µ–≤–∞—Ç—å –µ—ë –¥–Ω–µ–º.
ü§û <b>–°—á–∞—Å—Ç–ª–∏–≤—á–∏–∫</b> - –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏ –º–æ–∂–µ—Ç –ø–æ–≤–µ–∑—Ç–∏ –∏ –æ–Ω –Ω–µ —É–º—Ä—ë—Ç.
ü§µüèª <b>–î–æ–Ω</b> - –≥–ª–∞–≤–∞ –º–∞—Ñ–∏–∏, –Ω–æ—á—å—é —É–±–∏–≤–∞–µ—Ç –∏–≥—Ä–æ–∫–∞.
ü§µüèº <b>–ö—Ä—ë—Å—Ç–Ω—ã–π –æ—Ç–µ—Ü</b> - –ø–æ–º–æ—â–Ω–∏–∫ –º–∞—Ñ–∏–∏, –ª–∏—à–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –≥–æ–ª–æ—Å–∞ –¥–Ω–µ–º, –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏ –¥–æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≥–ª–∞–≤–æ–π –º–∞—Ñ–∏–∏.
üë®üèº‚Äç‚öïÔ∏è <b>–î–æ–∫—Ç–æ—Ä</b> - –ª–µ—á–∏—Ç –∂–∏—Ç–µ–ª–µ–π, –Ω–æ –µ—Å–ª–∏ –ø–æ–ª–µ—á–∏—Ç –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ 2 —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥, –∞ –≤ –Ω–µ–≥–æ –Ω–µ —Å—Ç—Ä–µ–ª—è–ª–∏ –Ω–∏ —Ä–∞–∑—É, —Ç–æ –∑–∞–ª–µ—á–∏–≤–∞–µ—Ç –µ–≥–æ –¥–æ —Å–º–µ—Ä—Ç–∏.
üïµüèºÔ∏è‚Äç‚ôÇÔ∏è <b>–ö–æ–º–∏—Å—Å–∞—Ä</b> - –∏—â–µ—Ç –º–∞—Ñ–∏—é, –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–ª–∏ —É–±–∏—Ç—å –∏–≥—Ä–æ–∫–∞.
üëÆüèª <b>–õ–µ–π—Ç–µ–Ω–∞–Ω—Ç</b> - –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–º–∏—Å—Å–∞—Ä–∞, –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏ –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–≤—ã—à–µ–Ω–∏–µ –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫–æ–º–∏—Å—Å–∞—Ä–æ–º.
ü§¶üèº‚Äç‚ôÇÔ∏è <b>–ö–∞–º–∏–∫–∞–¥–∑–µ</b> - —Å–º–µ—Ä—Ç–Ω–∏–∫, –µ–≥–æ —Ü–µ–ª—å –±—ã—Ç—å –ø–æ–≤–µ—à–∞–Ω—ã–º –Ω–∞ –¥–Ω–µ–≤–Ω–æ–º —Å–æ–±—Ä–∞–Ω–∏–∏.
üë• <b>–¢–µ–ª–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å</b> - –ø—Ä–∏–∫—Ä—ã–≤–∞–µ—Ç –ª—é–±–æ–≥–æ –∏–≥—Ä–æ–∫–∞, –ø—Ä–∏ —Ä–∞–Ω–µ–µ —É—Ö–æ–¥–∏—Ç —Å —Ä–∞–±–æ—Ç—ã, –Ω–æ —Å–ø–∞—Å–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –æ—Ç —Å–º–µ—Ä—Ç–∏.
üî™ <b>–ú—Å—Ç–∏—Ç–µ–ª—å</b> - –µ–¥–∏–Ω–æ–ª–∏—á–Ω–æ —Ö–æ—á–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –º–∞—Ñ–∏–µ–π, –º–æ–∂–µ—Ç —É–±–∏–≤–∞—Ç—å –ª—é–±–æ–≥–æ –∂–∏—Ç–µ–ª—è.
üíÉüèª <b>–ö—Ä–∞—Å–æ—Ç–∫–∞</b> - –æ—Ç–≤–ª–µ–∫–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –Ω–æ—á—å—é –∏ –æ–Ω –ª–∏—à–∞–µ—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å.
üë≥üèª‚Äç‚ôÇÔ∏è <b>–¢—Ä–∏–∞–¥–∞</b> - –≥–ª–∞–≤–∞ 2 –ø—Ä–µ—Å—Ç—É–ø–Ω–æ–≥–æ –∫–ª–∞–Ω–∞ –≤ –≥–æ—Ä–æ–¥–µ, —Ü–µ–ª—å –∫–æ—Ç–æ—Ä–æ–≥–æ —É–±–∏—Ç—å –º–∞—Ñ–∏—é –∏ –º–∏—Ä–Ω—ã—Ö –∂–∏—Ç–µ–ª–µ–π.
üßòüèª <b>–°–µ–Ω—Å–µ–π</b> - –ø–æ–º–æ—â–Ω–∏–∫ —Ç—Ä–∏–∞–¥—ã, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–≥—Ä–æ–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–µ —Ä–æ–ª–∏ –∫–æ–º–∏—Å—Å–∞—Ä–∞ –∏–ª–∏ –º–∞—Ñ–∏–∏, –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏ —Ç—Ä–∏–∞–¥—ã –∑–∞–Ω–∏–º–∞–µ—Ç –µ–≥–æ –º–µ—Å—Ç–æ.
<b>–í—ã –∏ –≤–∞—à–∏ —Å–æ—é–∑–Ω–∏–∫–∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è</b> ‚òëÔ∏è`, {parse_mode: 'HTML'});
});

//–û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
bot.command('stopgame', (ctx) => {
  game.clearDataGame(ctx.message.chat.id);
});

//–û—Ç–º–µ—á–∞–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ—Ç–æ—Ä—ã—Ö –∑–Ω–∞–µ—Ç –±–æ—Ç
bot.command('call', (ctx) => {
  functions.callUsers(ctx);
});

//–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
bot.command('userinfo', (ctx) => {
  functions.getInfoUser(ctx.message.chat.id, ctx.message.from.id);
});

//–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —á–∞—Ç–∞
bot.command('chatinfo', (ctx) => {
  functions.getInfoChat(ctx.message.chat.id);
});

//–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ø —á–∞—Ç–∞
bot.command('topvictories', (ctx) => {
  functions.topChat(ctx.message.chat.id, '–ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π', 'victories');
});

//–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ø —á–∞—Ç–∞
bot.command('topworld', (ctx) => {
  functions.topChat(ctx.message.chat.id, '–ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –≤ –º–∏—Ä–Ω–æ–π —Ä–æ–ª–∏', 'worldVictories');
});

//–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ø —á–∞—Ç–∞
bot.command('topmafia', (ctx) => {
  functions.topChat(ctx.message.chat.id, '–ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –≤ —Ä–æ–ª–∏ –º–∞—Ñ–∏–∏', 'mafiaVictories');
});

//–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ø —á–∞—Ç–∞
bot.command('toptriada', (ctx) => {
  functions.topChat(ctx.message.chat.id, '–ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –≤ —Ä–æ–ª–∏ —Ç—Ä–∏–∞–¥—ã', 'triadaVictories');
});

//–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
bot.on('new_chat_members', (ctx) => {
  if (functions.checkTypeChat(ctx.message.chat.type)) {
    functions.checkingLoggedUser(ctx.message.chat.id, ctx.message.new_chat_members);
  } else {
    functions.leaveChat(ctx.message.chat.id);
  }
});


//–ü—Ä–∏ –≤—ã—Ö–æ–¥–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ –±–¥
bot.on('left_chat_member', (ctx) => {
  functions.leftUserOrChat(ctx.message.chat.id, ctx.message.left_chat_member);
});


//–õ–æ–≤–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ —á–∞—Ç–∞ –∏ –µ–≥–æ –∞–π–¥–∏
bot.on('migrate_to_chat_id', (ctx) => {
  functions.autoUpdateIDChat(ctx.message.chat.id, ctx.message.migrate_to_chat_id);
});


//–õ–æ–≤–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —á–∞—Ç–∞
bot.on('new_chat_title', (ctx) => {
  functions.autoUpdateTitleChat(ctx.message.chat.id, ctx.message.chat.title);
});


//–õ–æ–≤–∏–º –∫–æ–ª–±–µ–∫–∏ –æ—Ç –∫–Ω–æ–ø–æ–∫
bot.on('callback_query', (ctx) => {
  game.callbackQuery(ctx);
});


//–£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–æ—á—å –∏–ª–∏ —É–±–∏—Ç
bot.on('message', (ctx) => {
  if (functions.checkTypeChat(ctx.message.chat.type)) {
    game.closeWriteChat(ctx);
  }
});


//–ó–∞–ø—É—Å–∫–∞–µ–º –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø–æ–ª–∏–Ω–≥–∞
bot.launch();
//bot.startWebhook(`/${process.env.SECRET}`, null, PORT);